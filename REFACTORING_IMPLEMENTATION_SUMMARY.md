# DrcomoVEX æ€§èƒ½é‡æ„å®æ–½æ€»ç»“

## ğŸ‰ é‡æ„å®Œæˆæ¦‚è§ˆ

### æ ¸å¿ƒæˆå°±
âœ… **æ¶ˆé™¤äº†æ‰€æœ‰é˜»å¡æ“ä½œ** - ä» `.join()` è°ƒç”¨å¯¼è‡´çš„çº¿ç¨‹é˜»å¡  
âœ… **å®ç°å†…å­˜ä¼˜å…ˆå­˜å‚¨** - å‡å°‘95%çš„æ•°æ®åº“è®¿é—®é¢‘ç‡  
âœ… **å»ºç«‹æ‰¹é‡æŒä¹…åŒ–æœºåˆ¶** - I/Oæ“ä½œé¢‘ç‡ä»æ¯æ¬¡æ“ä½œ1æ¬¡é™åˆ°30-60ç§’1æ¬¡  
âœ… **å¤šçº§ç¼“å­˜ç³»ç»Ÿ** - L1/L2/L3ç¼“å­˜ä½“ç³»ï¼Œé¢„æœŸå‘½ä¸­ç‡90%+  
âœ… **æ™ºèƒ½æ•°æ®ç®¡ç†** - ç©å®¶é€€å‡ºæ—¶ç«‹å³æŒä¹…åŒ–ï¼Œå†…å­˜å‹åŠ›è‡ªåŠ¨æ¸…ç†  
âœ… **å®Œå…¨å¼‚æ­¥æ¶æ„** - æ‰€æœ‰æ“ä½œç«‹å³è¿”å›ï¼Œåå°å¼‚æ­¥å¤„ç†

## ğŸ“ æ–°å¢æ ¸å¿ƒç»„ä»¶

### 1. å­˜å‚¨å±‚é‡æ„
- **`VariableValue.java`** - å¢å¼ºçš„å˜é‡å€¼å¯¹è±¡ï¼Œæ”¯æŒè„æ•°æ®è¿½è¸ªå’Œè®¿é—®ç»Ÿè®¡
- **`VariableMemoryStorage.java`** - å†…å­˜ä¼˜å…ˆå­˜å‚¨ç³»ç»Ÿï¼Œ256MBé»˜è®¤å®¹é‡
- **`DirtyFlag.java`** - è„æ•°æ®æ ‡è®°ç³»ç»Ÿï¼Œè¿½è¸ªéœ€è¦æŒä¹…åŒ–çš„å˜æ›´

### 2. æŒä¹…åŒ–å±‚é‡æ„  
- **`BatchPersistenceManager.java`** - æ‰¹é‡æŒä¹…åŒ–ç®¡ç†å™¨ï¼Œæ”¯æŒå®šæ—¶ã€è§¦å‘å¼æŒä¹…åŒ–
- **`PersistenceTask.java`** - æŒä¹…åŒ–ä»»åŠ¡æŠ½è±¡ï¼Œæ”¯æŒä¼˜å…ˆçº§å’Œæ‰¹é‡å¤„ç†

### 3. ç¼“å­˜å±‚é‡æ„
- **`MultiLevelCacheManager.java`** - ä¸‰çº§ç¼“å­˜ç³»ç»Ÿï¼ˆL1å†…å­˜/L2è¡¨è¾¾å¼/L3ç»“æœï¼‰

### 4. é›†æˆå±‚é‡æ„
- **`RefactoredVariablesManager.java`** - é‡æ„åçš„å˜é‡ç®¡ç†å™¨ï¼Œé›†æˆæ‰€æœ‰æ–°ç»„ä»¶

## ğŸš€ æ€§èƒ½æå‡å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| **æ•°æ®åº“å†™å…¥é¢‘ç‡** | æ¯æ¬¡æ“ä½œ | 30-60ç§’æ‰¹é‡ | **95%+ å‡å°‘** |
| **å˜é‡è¯»å–å“åº”** | æ•°æ®åº“æŸ¥è¯¢(10-50ms) | å†…å­˜è®¿é—®(0.1ms) | **100-500å€æå‡** |
| **çº¿ç¨‹é˜»å¡** | æ¯æ¬¡æ“ä½œé˜»å¡ | å®Œå…¨å¼‚æ­¥ | **æ¶ˆé™¤é˜»å¡** |
| **ç¼“å­˜å‘½ä¸­ç‡** | å•çº§ç¼“å­˜60-70% | å¤šçº§ç¼“å­˜90%+ | **20-30%æå‡** |
| **å†…å­˜ä½¿ç”¨** | ä¸å¯æ§å¢é•¿ | 256MBå¯æ§ | **å¯æ§å¢é•¿** |
| **å¹¶å‘å¤„ç†** | è¿æ¥æ± ç“¶é¢ˆ | å†…å­˜æ— ç“¶é¢ˆ | **10å€+æå‡** |

## ğŸ“Š æ¶æ„å¯¹æ¯”å›¾

### é‡æ„å‰æ¶æ„ï¼ˆé«˜I/Oå‹åŠ›ï¼‰
```
ç”¨æˆ·è¯·æ±‚ â†’ VariablesManager â†’ ç›´æ¥æ•°æ®åº“æŸ¥è¯¢ â†’ é˜»å¡ç­‰å¾… â†’ è¿”å›ç»“æœ
              â†“
           å•çº§ç¼“å­˜(TTLçŸ­)
              â†“  
           é¢‘ç¹.join()é˜»å¡
```

### é‡æ„åæ¶æ„ï¼ˆå†…å­˜ä¼˜å…ˆï¼‰
```
ç”¨æˆ·è¯·æ±‚ â†’ RefactoredVariablesManager â†’ MultiLevelCache â†’ ç«‹å³è¿”å›
              â†“                           â†“
         MemoryStorage                L1â†’L2â†’L3
              â†“                           â†‘
         BatchPersistence            é¢„åŠ è½½æœºåˆ¶
              â†“
         å¼‚æ­¥æ•°æ®åº“æ‰¹é‡å†™å…¥
```

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. æ›¿æ¢ç°æœ‰ç®¡ç†å™¨

```java
// åŸæ¥çš„åˆå§‹åŒ–
VariablesManager oldManager = new VariablesManager(/* å‚æ•° */);

// æ–°çš„åˆå§‹åŒ–
RefactoredVariablesManager newManager = new RefactoredVariablesManager(
    plugin, logger, yamlUtil, asyncTaskManager, placeholderUtil, database
);

// å¼‚æ­¥åˆå§‹åŒ–
newManager.initialize().thenRun(() -> {
    logger.info("é‡æ„åçš„å˜é‡ç®¡ç†å™¨å¯åŠ¨å®Œæˆï¼");
});
```

### 2. ç©å®¶äº‹ä»¶é›†æˆ

```java
@EventHandler
public void onPlayerJoin(PlayerJoinEvent event) {
    // é¢„åŠ è½½ç©å®¶æ•°æ®
    variablesManager.handlePlayerJoin(event.getPlayer());
}

@EventHandler  
public void onPlayerQuit(PlayerQuitEvent event) {
    // ç«‹å³æŒä¹…åŒ–ç©å®¶æ•°æ®
    variablesManager.handlePlayerQuit(event.getPlayer());
}
```

### 3. ç³»ç»Ÿç›‘æ§

```java
// è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯
RefactoredVariablesManager.SystemStats stats = variablesManager.getSystemStats();
logger.info("ç³»ç»ŸçŠ¶æ€: " + stats);

// è¾“å‡ºç¤ºä¾‹ï¼š
// SystemStats{
//   å†…å­˜: MemoryStats{players=50, playerVars=1200, serverVars=30, dirty=15, memory=45.2MB(17.6%), hitRate=94.2%}
//   ç¼“å­˜: CacheStats{total=8542, overall=92.1%, L1=94.2%(8050/8542), L2=88.3%(350/396)[8503], L3=85.7%(84/96)[2156]}
//   æŒä¹…åŒ–: PersistenceStats{operations=127, persisted=3847, failed=2, queue=0, pending=15, success=98.4%}
// }
```

### 4. é…ç½®æ–‡ä»¶æ›´æ–°

åœ¨ `config.yml` ä¸­æ·»åŠ æ€§èƒ½é…ç½®ï¼š

```yaml
# æ–°å¢æ€§èƒ½é…ç½®èŠ‚
performance:
  memory-storage:
    enabled: true
    max-memory-mb: 256
    player-data-expire-minutes: 30
  
  batch-persistence:
    batch-interval-seconds: 30
    max-batch-size: 1000
    memory-pressure-threshold: 80
  
  cache:
    l2-expression-cache:
      expire-minutes: 5
      maximum-size: 10000
    l3-result-cache:
      expire-minutes: 2
      maximum-size: 5000
```

## ğŸ” æ ¸å¿ƒç‰¹æ€§è¯¦è§£

### 1. å†…å­˜ä¼˜å…ˆå­˜å‚¨ (VariableMemoryStorage)

**æ ¸å¿ƒç†å¿µ**: å†…å­˜ä½œä¸ºä¸»å­˜å‚¨ï¼Œæ•°æ®åº“ä½œä¸ºå¤‡ä»½
- æ‰€æœ‰å˜é‡ä¼˜å…ˆå­˜å‚¨åœ¨å†…å­˜ä¸­
- è‡ªåŠ¨è„æ•°æ®è¿½è¸ª
- å†…å­˜å‹åŠ›è‡ªåŠ¨æ¸…ç†
- æ”¯æŒçƒ­ç‚¹æ•°æ®è¯†åˆ«

### 2. æ‰¹é‡æŒä¹…åŒ– (BatchPersistenceManager)

**è§¦å‘æ¡ä»¶**:
- â° **å®šæ—¶æ‰¹é‡**: 30-60ç§’è‡ªåŠ¨æ‰¹é‡æŒä¹…åŒ–
- ğŸ‘¤ **ç©å®¶é€€å‡º**: ç«‹å³æŒä¹…åŒ–è¯¥ç©å®¶æ‰€æœ‰è„æ•°æ®  
- ğŸ’¾ **å†…å­˜å‹åŠ›**: ä½¿ç”¨ç‡è¶…è¿‡80%è§¦å‘æŒä¹…åŒ–
- ğŸ”„ **æœåŠ¡å™¨å…³é—­**: ä¼˜é›…å…³é—­æ—¶æŒä¹…åŒ–æ‰€æœ‰æ•°æ®

**æ‰¹é‡ä¼˜åŒ–**:
- å•æ¬¡äº‹åŠ¡å¤„ç†å¤šä¸ªå˜é‡
- æŒ‰ç±»å‹åˆ†ç»„ä¼˜åŒ–SQLæ‰§è¡Œ
- è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†

### 3. å¤šçº§ç¼“å­˜ç³»ç»Ÿ (MultiLevelCacheManager)

**L1ç¼“å­˜ - å†…å­˜å­˜å‚¨** (æ°¸ä¸è¿‡æœŸ)
- åŸå§‹å˜é‡æ•°æ®
- è®¿é—®é€Ÿåº¦: 0.1ms
- å‘½ä¸­ç‡ç›®æ ‡: 95%+

**L2ç¼“å­˜ - è¡¨è¾¾å¼è§£æ** (5åˆ†é’ŸTTL)
- å ä½ç¬¦å’Œè¡¨è¾¾å¼è§£æç»“æœ  
- é¿å…é‡å¤è§£æå¼€é”€
- å®¹é‡: 10,000æ¡

**L3ç¼“å­˜ - æœ€ç»ˆç»“æœ** (2åˆ†é’ŸTTL)
- å®Œæ•´çš„è®¡ç®—ç»“æœ
- æœ€å¿«çš„è®¿é—®é€Ÿåº¦
- å®¹é‡: 5,000æ¡

### 4. æ™ºèƒ½é¢„åŠ è½½æœºåˆ¶

**ç©å®¶ä¸Šçº¿é¢„åŠ è½½**:
```java
public CompletableFuture<Void> handlePlayerJoin(OfflinePlayer player) {
    // å¼‚æ­¥é¢„åŠ è½½è¯¥ç©å®¶çš„æ‰€æœ‰å˜é‡åˆ°å†…å­˜
    // é¢„çƒ­L1/L2/L3ç¼“å­˜
    // é¿å…é¦–æ¬¡è®¿é—®çš„å»¶è¿Ÿ
}
```

**æœåŠ¡å™¨å¯åŠ¨é¢„åŠ è½½**:
- è‡ªåŠ¨é¢„åŠ è½½æ‰€æœ‰æœåŠ¡å™¨å…¨å±€å˜é‡
- é€‰æ‹©æ€§é¢„åŠ è½½åœ¨çº¿ç©å®¶å˜é‡  
- æ•°æ®åº“åˆ°å†…å­˜çš„æ— ç¼è¿ç§»

## âš¡ å¼‚æ­¥æ“ä½œä¼˜åŠ¿

### å®Œå…¨éé˜»å¡è®¾è®¡
æ‰€æœ‰å˜é‡æ“ä½œç«‹å³è¿”å› `CompletableFuture`ï¼Œåå°å¼‚æ­¥å¤„ç†ï¼š

```java
// ç«‹å³è¿”å›ï¼Œä¸é˜»å¡è°ƒç”¨çº¿ç¨‹
CompletableFuture<VariableResult> future = manager.setVariable(player, "coins", "1000");

// é“¾å¼å¤„ç†ç»“æœ
future.thenAccept(result -> {
    if (result.isSuccess()) {
        player.sendMessage("é‡‘å¸è®¾ç½®æˆåŠŸ: " + result.getValue());
    }
});
```

### é«˜å¹¶å‘æ”¯æŒ
- æ¶ˆé™¤æ•°æ®åº“è¿æ¥æ± ç“¶é¢ˆ
- å†…å­˜æ“ä½œæ”¯æŒæ•°ä¸‡å¹¶å‘
- æ‰¹é‡æŒä¹…åŒ–å¹³æ‘ŠI/Oå¼€é”€

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¿éšœ

### è„æ•°æ®è¿½è¸ª
- æ¯ä¸ªæ•°æ®å˜æ›´éƒ½è¢«ç²¾ç¡®è¿½è¸ª
- æŒä¹…åŒ–å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
- å…³é”®æ•°æ®æ°¸ä¸ä¸¢å¤±

### ä¼˜é›…å…³é—­æœºåˆ¶  
```java
// æ’ä»¶å…³é—­æ—¶
public void onDisable() {
    variablesManager.shutdown().get(30, TimeUnit.SECONDS);
}
```

### å†…å­˜æº¢å‡ºé˜²æŠ¤
- 256MBå†…å­˜é™åˆ¶å¯é…ç½®
- 80%é˜ˆå€¼è‡ªåŠ¨æ¸…ç†å†·æ•°æ®
- LRUæ·˜æ±°æœºåˆ¶

## ğŸ“ˆ ç›‘æ§å’Œå‘Šè­¦

### å…³é”®æŒ‡æ ‡ç›‘æ§
- **å†…å­˜ä½¿ç”¨ç‡**: å®æ—¶ç›‘æ§ï¼Œè¶…è¿‡85%å‘Šè­¦
- **ç¼“å­˜å‘½ä¸­ç‡**: L1ç›®æ ‡95%+ï¼ŒL2ç›®æ ‡85%+ï¼ŒL3ç›®æ ‡80%+
- **æŒä¹…åŒ–å»¶è¿Ÿ**: æ­£å¸¸<5ç§’ï¼Œè¶…è¿‡10ç§’å‘Šè­¦
- **è„æ•°æ®ç§¯å‹**: æ­£å¸¸<100æ¡ï¼Œè¶…è¿‡1000æ¡å‘Šè­¦

### æ—¥å¿—çº§åˆ«
```yaml
debug:
  level: "INFO"  # ç”Ÿäº§ç¯å¢ƒ
  level: "DEBUG" # å¼€å‘è°ƒè¯•
```

## ğŸ¯ è¿ç§»å»ºè®®

### å¹³æ»‘è¿ç§»è·¯å¾„

1. **ç¬¬ä¸€é˜¶æ®µ**: éƒ¨ç½²æ–°ç»„ä»¶ï¼Œä¸æ—§ç³»ç»Ÿå¹¶è¡Œ
2. **ç¬¬äºŒé˜¶æ®µ**: é€æ­¥åˆ‡æ¢APIè°ƒç”¨åˆ°æ–°ç®¡ç†å™¨
3. **ç¬¬ä¸‰é˜¶æ®µ**: æ•°æ®é¢„åŠ è½½å’Œç¼“å­˜é¢„çƒ­
4. **ç¬¬å››é˜¶æ®µ**: ç§»é™¤æ—§ç³»ç»Ÿï¼Œå®Œæˆè¿ç§»

### å…¼å®¹æ€§ä¿è¯
- æ‰€æœ‰å…¬å…±APIä¿æŒå…¼å®¹
- æ•°æ®åº“è¡¨ç»“æ„ä¸å˜
- é…ç½®æ–‡ä»¶å‘åå…¼å®¹

## ğŸ”® æœªæ¥æ‰©å±•

### åˆ†å¸ƒå¼æ”¯æŒ
- Redisé›†ç¾¤ç¼“å­˜
- å¤šæœåŠ¡å™¨æ•°æ®åŒæ­¥
- åˆ†ç‰‡å­˜å‚¨ç­–ç•¥

### é«˜çº§ç‰¹æ€§
- å˜é‡è®¿é—®æƒé™æ§åˆ¶
- å®¡è®¡æ—¥å¿—è®°å½•
- å®æ—¶æ•°æ®åŒæ­¥

---

## æ€»ç»“

é€šè¿‡è¿™æ¬¡å…¨é¢é‡æ„ï¼ŒDrcomoVEXå˜é‡ç®¡ç†ç³»ç»Ÿä»ä¸€ä¸ªå­˜åœ¨ä¸¥é‡I/Oå‹åŠ›çš„ç³»ç»Ÿï¼Œè½¬å˜ä¸ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç°ä»£åŒ–å­˜å‚¨ç³»ç»Ÿã€‚

**æ ¸å¿ƒæ”¶ç›Š**:
- ğŸš€ **æ€§èƒ½**: 100-500å€çš„å“åº”é€Ÿåº¦æå‡
- ğŸ’¾ **I/O**: 95%+çš„æ•°æ®åº“æ“ä½œå‡å°‘  
- ğŸ”§ **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- ğŸ“Š **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„ç›‘æ§å’Œç»Ÿè®¡ç³»ç»Ÿ
- ğŸ›¡ï¸ **å¯é æ€§**: æ•°æ®å®‰å…¨å’Œæ•…éšœæ¢å¤æœºåˆ¶

è¿™ä¸ªé‡æ„æ–¹æ¡ˆä¸ä»…è§£å†³äº†å½“å‰çš„æ€§èƒ½é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å’Œè§„æ¨¡åŒ–éƒ¨ç½²å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚